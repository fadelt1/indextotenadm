<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard de Choferes</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <style>
    :root{
      --primary:#002060;
      --secondary:#34d399;
      --danger:#e11d48;
      --warning:#f59e0b;
      --bg:#f4f6f9;
      --card:#ffffff;
      --text:#333;
      --sidebar:#001440;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:'Montserrat',sans-serif;background:var(--bg);color:var(--text)}
    header{
      position:sticky;
      top:0;
      z-index:30;
      background:var(--card);
      border-bottom:1px solid #e5e7eb;
      padding:14px 18px;
      text-align:center;   /* ‚úÖ centra el t√≠tulo */
    }
    .brand{
      font-weight:700;
      color:var(--primary);
      font-size:20px;
      letter-spacing:.3px;
      display:inline-block;
    }
    .wrap{display:grid;grid-template-columns:260px 1fr;min-height:100dvh}
    aside{
      background:var(--sidebar);color:#fff;padding:18px;position:sticky;top:0;align-self:start;height:100dvh
    }
    .side-title{font-size:14px;letter-spacing:.6px;opacity:.9;margin:8px 0 14px}
    .nav a{display:block;color:#fff;text-decoration:none;padding:10px 8px;border-radius:8px;opacity:.95}
    .nav a:hover{background:rgba(255,255,255,.08)}
    main{padding:18px}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:14px 0 18px}
    .card{
      background:var(--card);border-radius:14px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.06);
      border-top:5px solid transparent;display:flex;flex-direction:column;gap:8px;min-height:106px
    }
    .card .k{font-size:13px;color:#6b7280}
    .card .v{font-size:26px;font-weight:700;color:var(--primary)}
    .c1{border-top-color:var(--primary)}
    .c2{border-top-color:var(--danger)}
    .c3{border-top-color:var(--warning)}
    .c4{border-top-color:var(--secondary)}
    .toolbar{
      background:var(--card);border:1px solid #e5e7eb;border-radius:12px;padding:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center
    }
    .toolbar input,.toolbar select{
      padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;font-size:14px;min-width:160px
    }
    .btn{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--primary);color:#fff}
    .table-wrap{margin-top:14px;background:var(--card);border-radius:12px;border:1px solid #e5e7eb;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:14px;min-width:700px}
    th,td{padding:12px 10px;text-align:center;border-bottom:1px solid #f3f4f6}
    th{background:#0b1d57;color:#fff;cursor:pointer;user-select:none;position:sticky;top:0;z-index:1}
    tr:hover td{background:#fafafa}
    .estado{display:inline-flex;align-items:center;gap:6px;font-weight:700;padding:4px 10px;border-radius:999px}
    .ok{background:#e6f9f1;color:#065f46}
    .prox{background:#fff7ed;color:#9a3412}
    .bad{background:#fee2e2;color:#991b1b}
    .row-bad{background:#fff5f5}
    #grafico{background:var(--card);border:1px solid #e5e7eb;border-radius:12px;margin:16px 0;padding:8px}
    @media(max-width:980px){.wrap{grid-template-columns:1fr}aside{display:none}}
  </style>
</head>
<body>
  <header>
    <span class="brand">üöõ Dashboard de Desempe√±o de Choferes</span>
  </header>

  <div class="wrap">
    <aside>
      <div class="side-title">SEGUIMIENTO RV</div>
      <nav class="nav">
        <a href="#">Status de RV</a>
        <a href="https://fadelt1.github.io/seguimientoporchofer/" target="_blank" rel="noopener">Tramos por Chofer</a>
        <a href="https://fadelt1.github.io/historicorv/" target="_blank" rel="noopener">Hist√≥rico RV</a>
      </nav>
    </aside>

    <main>
      <!-- Cards -->
      <section class="cards">
        <div class="card c1"><div class="k">Total de RV</div><div class="v" id="k_totalRV">‚Ç≤ 0</div></div>
        <div class="card c2"><div class="k">Total fuera de la meta</div><div class="v" id="k_fuera">0</div></div>
        <div class="card c3"><div class="k">Tipo 2 fuera de meta</div><div class="v" id="k_t2">0</div></div>
        <div class="card c4"><div class="k">Tipo 3 fuera de meta</div><div class="v" id="k_t3">0</div></div>
      </section>

      <!-- Toolbar -->
      <section class="toolbar">
        <input id="search" type="text" placeholder="Buscar chofer..." />
        <select id="f_tipo">
          <option value="">Filtrar por Tipo</option>
          <option value="2">Tipo 2</option>
          <option value="3">Tipo 3</option>
        </select>
        <select id="f_estado">
          <option value="">Filtrar por Estado</option>
          <option value="ok">Cumple Meta</option>
          <option value="prox">Pr√≥ximo a llegar</option>
          <option value="bad">Fuera de Meta</option>
        </select>
        <select id="f_interior">
          <option value="">Filtrar Interior</option>
          <option value="con">Con viajes</option>
          <option value="sin">Sin viajes</option>
        </select>
        <button class="btn btn-primary" id="btn_csv">üì§ Exportar CSV</button>
      </section>

      <!-- Gr√°fico -->
      <div id="grafico"></div>

      <!-- Tabla -->
      <div class="table-wrap">
        <table id="tabla">
          <thead>
            <tr>
              <th data-col="chofer">Chofer</th>
              <th data-col="tipo">Tipo</th>
              <th data-col="rv">RV</th>
              <th data-col="viatico">Vi√°ticos</th>
              <th data-col="estado">Estado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
  </div>

<script>
const FIREBASE_URL = "https://toten-paraguay-5d90f-default-rtdb.firebaseio.com/.json";
const META_RV = 585000;
let viajes = [];
let rvPorChofer = {};
let sortState = { col: 'rv', dir: 'desc' };

const fmtGs = n => '‚Ç≤ ' + (Number(n)||0).toLocaleString('es-PY');

async function cargarDatos(){
  try{
    const res = await fetch(FIREBASE_URL);
    if(!res.ok) throw new Error('Error HTTP: '+res.status);
    const data = await res.json();
    viajes = data ? Object.values(data) : [];
  }catch(err){console.error(err);viajes=[];}
}

function agruparPorChofer(){
  rvPorChofer = viajes.reduce((acc,v)=>{
    const chofer=(v["MOTORISTA 1"]||"").trim();
    if(!chofer)return acc;
    const tipo=String(v["TIPO"]||"").trim();
    const rv=parseFloat(v["RV GENERAL"])||0;
    const viatico=parseFloat(v["VIATICO"])||0;
    if(!acc[chofer]) acc[chofer]={rvTotal:0,viaticoTotal:0,tipo};
    acc[chofer].rvTotal+=rv;
    acc[chofer].viaticoTotal+=viatico;
    if(tipo) acc[chofer].tipo=tipo;
    return acc;
  },{});
}

function kpis(){
  let totalRV=0;const t2=new Set(),t3=new Set(),fuera=new Set();
  for(const [ch,d] of Object.entries(rvPorChofer)){
    totalRV+=d.rvTotal;
    if(d.rvTotal<META_RV)fuera.add(ch);
    if(String(d.tipo)==='2'&&d.rvTotal<META_RV)t2.add(ch);
    if(String(d.tipo)==='3'&&d.rvTotal<META_RV)t3.add(ch);
  }
  document.getElementById('k_totalRV').textContent=fmtGs(totalRV);
  document.getElementById('k_fuera').textContent=fuera.size;
  document.getElementById('k_t2').textContent=t2.size;
  document.getElementById('k_t3').textContent=t3.size;
}

function estadoClase(rv){
  if(rv < 500000) return 'bad';          // fuera de meta
  if(rv < META_RV) return 'prox';        // pr√≥ximo a llegar
  return 'ok';                           // cumple meta
}
function estadoTexto(c){
  return c==='bad'?'Fuera de meta':(c==='prox'?'Pr√≥ximo a llegar':'Cumple meta');
}

function rowsFiltradas(){
  const q=(document.getElementById('search').value||'').toLowerCase();
  const ft=document.getElementById('f_tipo').value;
  const fe=document.getElementById('f_estado').value;
  const fi=document.getElementById('f_interior').value;
  let rows=Object.entries(rvPorChofer).map(([chofer,d])=>({
    chofer,tipo:String(d.tipo||''),rv:d.rvTotal,viatico:d.viaticoTotal,estado:estadoClase(d.rvTotal)
  }));
  if(q)rows=rows.filter(r=>r.chofer.toLowerCase().includes(q));
  if(ft)rows=rows.filter(r=>r.tipo===ft);
  if(fe)rows=rows.filter(r=>r.estado===fe);
  if(fi==="con") rows=rows.filter(r=>r.viatico>0);
  if(fi==="sin") rows=rows.filter(r=>r.viatico===0);
  const {col,dir}=sortState;
  rows.sort((a,b)=>{
    let A=a[col],B=b[col];
    if(col==='rv'||col==='viatico'){A=Number(A);B=Number(B);}else{A=(A||'').toString().toLowerCase();B=(B||'').toString().toLowerCase();}
    if(A<B)return dir==='asc'?-1:1;
    if(A>B)return dir==='asc'?1:-1;
    return 0;
  });
  return rows;
}

function renderTabla(){
  const tbody=document.querySelector('#tabla tbody');
  tbody.innerHTML='';
  const rows=rowsFiltradas();
  for(const r of rows){
    const tr=document.createElement('tr');
    if(r.estado==='bad')tr.classList.add('row-bad');
    tr.innerHTML=`
      <td>${r.chofer}</td>
      <td>${r.tipo||'-'}</td>
      <td>${fmtGs(r.rv)}</td>
      <td>${fmtGs(r.viatico)}</td>
      <td><span class="estado ${r.estado}">${r.estado==='ok'?'‚úÖ Cumple meta':(r.estado==='prox'?'‚ö†Ô∏è Pr√≥ximo a llegar':'‚ùå Fuera de meta')}</span></td>`;
    tbody.appendChild(tr);
  }
}

function renderGrafico(){
  const rvPorDia={},viaticoPorDia={};
  for(const v of viajes){
    const f=(v["DATA DA VIAGEM"]||'').toString().trim();
    if(!f)continue;
    const rv=parseFloat(v["RV GENERAL"])||0;
    const via=parseFloat(v["VIATICO"])||0;
    rvPorDia[f]=(rvPorDia[f]||0)+rv;
    viaticoPorDia[f]=(viaticoPorDia[f]||0)+via;
  }
  const fechas=Object.keys(rvPorDia).sort((a,b)=>new Date(a)-new Date(b));
  const rvData=fechas.map(f=>rvPorDia[f]);
  const viaData=fechas.map(f=>viaticoPorDia[f]||0);
  Highcharts.chart('grafico',{
    chart:{zoomType:'xy'},
    title:{text:'RV Total vs Vi√°tico Acumulado'},
    xAxis:{categories:fechas,crosshair:true},
    yAxis:[{title:{text:'RV Total (‚Ç≤)'},labels:{formatter(){return'‚Ç≤ '+Highcharts.numberFormat(this.value,0,',','.');}}},
           {title:{text:'Vi√°tico (‚Ç≤)'},opposite:true,labels:{formatter(){return'‚Ç≤ '+Highcharts.numberFormat(this.value,0,',','.');}}}],
    tooltip:{shared:true,formatter:function(){let s='<b>'+this.x+'</b>';this.points.forEach(p=>{s+='<br/>'+p.series.name+': <b>‚Ç≤ '+Highcharts.numberFormat(p.y,0,',','.')+'</b>';});return s;}},
    series:[{name:'RV Total',type:'column',data:rvData},{name:'Vi√°tico',type:'spline',yAxis:1,data:viaData}]
  });
}

function exportCSV(){
  const rows=rowsFiltradas();
  const head=['Chofer','Tipo','RV','Vi√°ticos','Estado'];
  const body=rows.map(r=>[r.chofer,r.tipo,r.rv,r.viatico,estadoTexto(r.estado)]);
  const csv=[head.join(','),...body.map(row=>row.join(','))].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='choferes.csv';a.click();URL.revokeObjectURL(a.href);
}

document.getElementById('btn_csv').addEventListener('click',exportCSV);
['search','f_tipo','f_estado','f_interior'].forEach(id=>{
  document.getElementById(id).addEventListener('input',renderTabla);
  document.getElementById(id).addEventListener('change',renderTabla);
});
document.querySelectorAll('th[data-col]').forEach(th=>{
  th.addEventListener('click',()=>{
    const col=th.dataset.col;
    if(sortState.col===col){sortState.dir=sortState.dir==='asc'?'desc':'asc';}
    else{sortState.col=col;sortState.dir=(col==='chofer'||col==='estado')?'asc':'desc';}
    renderTabla();
  });
});

(async function init(){await cargarDatos();agruparPorChofer();kpis();renderTabla();renderGrafico();})();
</script>
</body>
</html>
